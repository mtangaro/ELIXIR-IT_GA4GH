---
- name: Download TESK
  git:
    repo: 'https://github.com/EMBL-EBI-TSI/TESK.git'
    dest: '{{ tesk_FS_path }}'
    version: '{{ tesk_version }}'

- name: Install shinto-cli
  pip:
    name: shinto-cli

- name: Edit config.ini
  ini_file:
    dest: '{{ tesk_FS_path }}/TESK/deployment/common/config.ini'
    section: '{{ item.section }}'
    option: '{{ item.option }}'
    value: '{{ item.value}}'
  with_items:
    - { section: 'auth', option: 'mode', value: '{{ auth_mode }}' }
    - { section: 'service', option: 'type', value: '{{ tesk_sevice_type }}' }

- name: Build k8s yaml
  shell: 'j2 -g "*.j2" config.ini'
  args:
    chdir: '{{ tesk_FS_path }}/TESK/deployment/common/'

- name: Put tesk service on a specific port
  blockinfile:
    dest: '{{ tesk_FS_path }}/TESK/deployment/common/tesk-svc.yaml'
    insertafter: '  type: NodePort'
    block: |
      ports:
      - nodePort: '{{ tesk_port }}'
        port: 8080

- name: Build tesk
  shell: 'kubectl create -f .'
  args:
    chdir: '{{ tesk_FS_path }}/TESK/deployment/common/'
